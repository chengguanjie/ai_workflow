// Prisma Schema for AI Workflow

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

// ============================================
// 企业与用户
// ============================================

model Organization {
  id          String   @id @default(cuid())
  name        String
  logo        String?
  description String?  @db.Text
  industry    String?
  website     String?
  phone       String?
  address     String?
  plan        Plan     @default(FREE)
  apiQuota    Int      @default(10000)
  apiUsed     Int      @default(0)

  // 企业状态（平台管理）
  status       OrgStatus @default(ACTIVE)
  statusReason String?   // 状态变更原因（如禁用原因）

  // 平台管理相关
  createdByAdminId String?  // 由哪个平台管理员创建（自助注册则为空）
  notes            String?  @db.Text  // 平台备注

  // 账单联系信息
  billingEmail   String?
  billingContact String?

  // 安全设置
  securitySettings Json @default("{}")
  // 包含: {
  //   passwordMinLength: number (默认8)
  //   passwordRequireUppercase: boolean (默认false)
  //   passwordRequireNumber: boolean (默认false)
  //   passwordRequireSymbol: boolean (默认false)
  //   sessionTimeout: number (分钟, 默认10080=7天)
  //   maxLoginAttempts: number (默认5)
  //   ipWhitelist: string[] (空数组表示不限制)
  //   twoFactorRequired: boolean (默认false)
  // }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  workflows   Workflow[]
  apiKeys     ApiKey[]
  apiTokens   ApiToken[]
  invitations Invitation[]
  knowledgeBases KnowledgeBase[]

  @@map("organizations")
}

enum OrgStatus {
  PENDING    // 待激活
  ACTIVE     // 正常
  SUSPENDED  // 已暂停（欠费等）
  DISABLED   // 已禁用
}

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  avatar       String?
  passwordHash String
  role         Role      @default(MEMBER)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  workflows  Workflow[]
  executions Execution[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  MEMBER
  VIEWER
}

model Invitation {
  id         String         @id @default(cuid())
  email      String?        // 可为空，链接邀请时不需要邮箱
  role       Role           @default(MEMBER)
  token      String         @unique
  type       InvitationType @default(EMAIL)
  expiresAt  DateTime
  acceptedAt DateTime?
  maxUses    Int            @default(1)  // 最大使用次数（链接邀请可设置多次）
  usedCount  Int            @default(0)  // 已使用次数

  createdAt DateTime @default(now())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  invitedById String?  // 邀请人 ID

  @@index([token])
  @@index([organizationId])
  @@map("invitations")
}

enum InvitationType {
  EMAIL  // 邮件邀请（指定邮箱）
  LINK   // 链接邀请（任何人可用）
}

// ============================================
// API Key 管理
// ============================================

model ApiKey {
  id           String     @id @default(cuid())
  name         String
  provider     AIProvider
  baseUrl      String     @default("")  // API 基础地址
  keyEncrypted String     @db.Text
  keyMasked    String
  defaultModel String     @default("")
  models       Json       @default("[]") // 可用模型列表
  isDefault    Boolean    @default(false)
  isActive     Boolean    @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("api_keys")
}

enum AIProvider {
  SHENSUAN
  OPENROUTER
  OPENAI
  ANTHROPIC
  BAIDU_WENXIN
  ALIYUN_TONGYI
  XUNFEI_SPARK
  STABILITYAI
}

// ============================================
// API Token (用于外部调用工作流)
// ============================================

model ApiToken {
  id          String    @id @default(cuid())
  name        String                          // Token 名称
  token       String    @unique               // 完整 Token (仅创建时显示一次)
  tokenHash   String    @unique               // Token 哈希值 (用于验证)
  prefix      String                          // Token 前缀 (如 wf_xxx, 用于识别)
  lastUsedAt  DateTime?                       // 最后使用时间
  expiresAt   DateTime?                       // 过期时间 (null 表示永不过期)
  isActive    Boolean   @default(true)        // 是否启用

  // 权限控制
  scopes      Json      @default("[]")        // 权限范围 ["workflow:execute", "workflow:read"]

  // 使用统计
  usageCount  Int       @default(0)           // 调用次数

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // 关联
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  createdById    String                       // 创建者 ID

  @@index([organizationId])
  @@index([tokenHash])
  @@index([prefix])
  @@map("api_tokens")
}

// ============================================
// 工作流
// ============================================

model Workflow {
  id          String    @id @default(cuid())
  name        String
  description String?   @db.Text
  category    String?
  tags        Json      @default("[]")
  isActive    Boolean   @default(true)
  isPublic    Boolean   @default(false)
  version     Int       @default(1)

  // 工作流配置 (JSON)
  config Json

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  creatorId String
  creator   User   @relation(fields: [creatorId], references: [id])

  executions Execution[]
  triggers   WorkflowTrigger[]

  @@index([organizationId])
  @@index([creatorId])
  @@index([deletedAt])
  @@map("workflows")
}

// ============================================
// 工作流触发器（Webhook / 定时任务）
// ============================================

model WorkflowTrigger {
  id          String       @id @default(cuid())
  name        String       // 触发器名称
  type        TriggerType  // 触发器类型
  enabled     Boolean      @default(true)

  // Webhook 配置
  webhookPath   String?    @unique  // Webhook 路径标识 (如: abc123)
  webhookSecret String?    @db.Text // 签名密钥 (HMAC-SHA256)

  // 定时任务配置
  cronExpression String?   // Cron 表达式 (如: 0 0 * * *)
  timezone       String?   @default("Asia/Shanghai")

  // 执行配置
  inputTemplate  Json?     // 默认输入模板
  retryOnFail    Boolean   @default(false)
  maxRetries     Int       @default(3)

  // 统计信息
  triggerCount     Int       @default(0)
  lastTriggeredAt  DateTime?
  lastSuccessAt    DateTime?
  lastFailureAt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  createdById String  // 创建者 ID

  logs TriggerLog[]

  @@index([workflowId])
  @@index([type])
  @@index([enabled])
  @@index([webhookPath])
  @@map("workflow_triggers")
}

enum TriggerType {
  MANUAL    // 手动触发
  WEBHOOK   // Webhook 触发
  SCHEDULE  // 定时任务
}

model TriggerLog {
  id          String        @id @default(cuid())
  status      TriggerStatus

  // 请求信息 (Webhook)
  requestMethod  String?    // GET, POST 等
  requestHeaders Json?      // 请求头
  requestBody    Json?      // 请求体
  requestIp      String?    // 来源 IP

  // 响应/结果
  executionId    String?    // 关联的执行记录 ID
  responseCode   Int?       // HTTP 响应码
  errorMessage   String?    @db.Text

  // 时间
  triggeredAt    DateTime   @default(now())
  completedAt    DateTime?
  duration       Int?       // 毫秒

  // 关联
  triggerId String
  trigger   WorkflowTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@index([triggerId])
  @@index([status])
  @@index([triggeredAt])
  @@map("trigger_logs")
}

enum TriggerStatus {
  PENDING    // 等待中
  RUNNING    // 执行中
  SUCCESS    // 成功
  FAILED     // 失败
  SKIPPED    // 跳过（如工作流未激活）
}

// ============================================
// 工作流模板
// ============================================

model WorkflowTemplate {
  id            String   @id @default(cuid())
  name          String
  description   String?  @db.Text
  category      String   // AI处理/数据分析/文档生成等
  tags          Json     @default("[]") // 搜索标签
  thumbnail     String?  // 缩略图 URL

  // 工作流配置（节点+边）
  config        Json

  // 可见性控制
  visibility    TemplateVisibility @default(PRIVATE)
  organizationId String? // 企业模板归属（null 表示官方模板）

  // 创建者信息
  creatorId     String?  // null 表示官方模板
  creatorName   String?  // 创建者名称（用于显示）

  // 统计信息
  usageCount    Int      @default(0)
  rating        Float    @default(0)
  ratingCount   Int      @default(0)

  // 是否为官方模板
  isOfficial    Boolean  @default(false)

  // 版本信息
  version       String   @default("1.0.0")

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([category])
  @@index([visibility, organizationId])
  @@index([isOfficial])
  @@map("workflow_templates")
}

enum TemplateVisibility {
  PRIVATE      // 仅自己可见
  ORGANIZATION // 企业内可见
  PUBLIC       // 公开
}

// ============================================
// 执行记录
// ============================================

model Execution {
  id     String          @id @default(cuid())
  status ExecutionStatus @default(PENDING)

  input  Json
  output Json?

  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?

  totalTokens      Int     @default(0)
  promptTokens     Int     @default(0)
  completionTokens Int     @default(0)
  estimatedCost    Decimal? @db.Decimal(10, 6)

  error       String? @db.Text
  errorDetail Json?

  // 断点续执行支持
  checkpoint      Json?     // 保存已完成节点的输出和当前执行位置
  lastCheckpoint  DateTime? // 最后一次保存检查点的时间
  resumedFromId   String?   // 如果是恢复执行，关联原执行ID
  canResume       Boolean   @default(false) // 是否可以恢复执行

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  logs        ExecutionLog[]
  outputFiles OutputFile[]

  @@index([workflowId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("executions")
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

model ExecutionLog {
  id       String   @id @default(cuid())
  nodeId   String
  nodeName String
  nodeType NodeType

  input  Json
  output Json?
  status ExecutionStatus

  aiProvider       AIProvider?
  aiModel          String?
  promptTokens     Int?
  completionTokens Int?

  startedAt   DateTime
  completedAt DateTime?
  duration    Int?

  error String? @db.Text

  createdAt DateTime @default(now())

  executionId String
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([nodeId])
  @@map("execution_logs")
}

enum NodeType {
  TRIGGER
  INPUT
  PROCESS
  CODE
  OUTPUT
  DATA
  IMAGE
  VIDEO
  AUDIO
  CONDITION
  LOOP
  HTTP
  MERGE
  IMAGE_GEN
  NOTIFICATION
}

// ============================================
// 输出文件
// ============================================

model OutputFile {
  id       String @id @default(cuid())

  // 文件基本信息
  fileName    String              // 原始文件名
  fileKey     String   @unique    // 存储路径/键 (用于云存储)
  format      OutputFormat        // 输出格式
  mimeType    String              // MIME 类型
  size        Int                 // 文件大小 (字节)

  // 存储信息
  storageType StorageType @default(LOCAL)  // 存储类型
  url         String?     @db.Text         // 完整访问 URL

  // 下载控制
  downloadCount Int       @default(0)      // 下载次数
  maxDownloads  Int?                       // 最大下载次数限制
  expiresAt     DateTime?                  // 过期时间

  // 元数据
  metadata Json?                           // 额外元数据 (如图片尺寸、视频时长等)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  executionId String
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  nodeId String                            // 生成此文件的节点 ID

  organizationId String

  @@index([executionId])
  @@index([organizationId])
  @@index([fileKey])
  @@index([expiresAt])
  @@map("output_files")
}

enum OutputFormat {
  TEXT
  JSON
  MARKDOWN
  HTML
  WORD
  EXCEL
  PDF
  IMAGE
  AUDIO
  VIDEO
}

enum StorageType {
  LOCAL       // 本地存储
  ALIYUN_OSS  // 阿里云 OSS
  AWS_S3      // AWS S3
  CUSTOM      // 自定义存储
}

// ============================================
// 审计日志
// ============================================

model AuditLog {
  id         String  @id @default(cuid())
  action     String
  resource   String
  resourceId String?
  detail     Json?
  ip         String?
  userAgent  String? @db.Text

  createdAt DateTime @default(now())

  userId         String?
  organizationId String?

  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
  @@map("audit_logs")
}

// ============================================
// 平台管理（Console）
// ============================================

model PlatformAdmin {
  id           String       @id @default(cuid())
  email        String       @unique
  name         String?
  passwordHash String
  role         PlatformRole @default(OPERATOR)
  isActive     Boolean      @default(true)
  lastLoginAt  DateTime?

  // 登录安全
  loginAttempts    Int       @default(0)   // 登录失败次数
  lockedUntil      DateTime?               // 锁定截止时间

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 创建者（用于审计，首个超管为空）
  createdById String?

  // 关联
  auditLogs PlatformAuditLog[]

  @@index([email])
  @@map("platform_admins")
}

enum PlatformRole {
  SUPER_ADMIN // 超级管理员 - 全部权限
  ADMIN       // 管理员 - 企业管理、用户管理
  OPERATOR    // 运营 - 查看数据、处理工单
  SUPPORT     // 客服 - 只读 + 工单处理
}

model PlatformAuditLog {
  id         String  @id @default(cuid())
  action     String  // CREATE_ORG, UPDATE_ORG, DISABLE_ORG, CREATE_ADMIN, etc.
  resource   String  // organization, user, plan, admin
  resourceId String?
  detail     Json?   // 详细变更内容
  ip         String?
  userAgent  String? @db.Text

  createdAt DateTime @default(now())

  adminId String
  admin   PlatformAdmin @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([resource])
  @@index([action])
  @@index([createdAt])
  @@map("platform_audit_logs")
}

// ============================================
// 企业申请（自助注册审批）
// ============================================

model OrgApplication {
  id String @id @default(cuid())

  // 企业信息
  orgName     String   // 企业名称
  industry    String?  // 所属行业
  website     String?  // 企业网站
  phone       String?  // 联系电话
  address     String?  // 地址
  description String?  @db.Text // 企业简介

  // 申请人信息（将成为企业主）
  contactName  String  // 联系人姓名
  contactEmail String  // 联系人邮箱
  contactPhone String? // 联系人电话

  // 申请状态
  status       ApplicationStatus @default(PENDING)
  rejectReason String?           // 拒绝原因

  // 审批信息
  reviewedAt   DateTime? // 审批时间
  reviewedById String?   // 审批人ID

  // 转化信息（审批通过后）
  organizationId String? // 创建的企业ID

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([contactEmail])
  @@index([createdAt])
  @@map("org_applications")
}

enum ApplicationStatus {
  PENDING  // 待审批
  APPROVED // 已通过
  REJECTED // 已拒绝
}

// ============================================
// 知识库 RAG 系统
// ============================================

model KnowledgeBase {
  id             String   @id @default(cuid())
  name           String
  description    String?  @db.Text

  // 向量化配置
  embeddingModel   String  @default("text-embedding-ada-002")
  embeddingProvider AIProvider @default(OPENAI)
  chunkSize        Int     @default(1000)  // 分块大小（字符数）
  chunkOverlap     Int     @default(200)   // 分块重叠

  // 向量存储配置
  vectorStoreType   VectorStoreType @default(PGVECTOR)
  vectorStoreConfig Json            @default("{}")  // 向量数据库连接配置

  // 统计信息
  documentCount Int @default(0)
  chunkCount    Int @default(0)
  totalSize     Int @default(0)  // 总文件大小（字节）

  // 状态
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  creatorId String?  // 创建者

  documents KnowledgeDocument[]

  @@index([organizationId])
  @@index([isActive])
  @@map("knowledge_bases")
}

enum VectorStoreType {
  PGVECTOR    // PostgreSQL pgvector 扩展
  PINECONE    // Pinecone 向量数据库
  QDRANT      // Qdrant 向量数据库
  MILVUS      // Milvus 向量数据库
  MEMORY      // 内存存储（仅开发测试）
}

model KnowledgeDocument {
  id              String   @id @default(cuid())

  // 文件信息
  fileName        String
  fileType        String          // pdf, docx, md, txt 等
  fileSize        Int             // 文件大小（字节）
  fileUrl         String?         // 原始文件存储 URL
  fileKey         String?         // 存储路径/键

  // 处理状态
  status          DocProcessStatus @default(PENDING)
  errorMessage    String?          @db.Text

  // 处理结果
  chunkCount      Int       @default(0)
  processedAt     DateTime?

  // 元数据
  metadata        Json      @default("{}")  // 额外信息如页数、字数等

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // 关联
  knowledgeBaseId String
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)

  uploadedById    String?  // 上传者

  chunks          DocumentChunk[]

  @@index([knowledgeBaseId])
  @@index([status])
  @@map("knowledge_documents")
}

enum DocProcessStatus {
  PENDING     // 待处理
  PROCESSING  // 处理中
  COMPLETED   // 已完成
  FAILED      // 失败
}

model DocumentChunk {
  id          String @id @default(cuid())

  // 内容
  content     String @db.Text        // 分块文本内容

  // 向量（存储为 JSON 数组，实际向量检索使用 pgvector）
  embedding   Json?                  // 向量数据 [0.1, 0.2, ...]

  // 位置信息
  chunkIndex  Int                    // 分块序号
  startOffset Int?                   // 在原文中的起始位置
  endOffset   Int?                   // 在原文中的结束位置

  // 元数据
  metadata    Json   @default("{}")  // 页码、章节等信息

  createdAt   DateTime @default(now())

  // 关联
  documentId  String
  document    KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([chunkIndex])
  @@map("document_chunks")
}
