generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

// =========================================================================================
// Core Identity & Access Management (IAM)
// =========================================================================================

model Organization {
  id                String             @id @default(cuid())
  name              String
  logo              String?
  plan              Plan               @default(FREE)
  apiQuota          Int                @default(10000)
  apiUsed           Int                @default(0)
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  address           String?
  description       String?            @db.Text
  industry          String?
  phone             String?
  securitySettings  Json
  website           String?
  billingContact    String?
  billingEmail      String?
  createdByAdminId  String?
  notes             String?            @db.Text
  status            OrgStatus          @default(ACTIVE)
  statusReason      String?
  users             User[]
  workflows         Workflow[]
  apiKeys           ApiKey[]
  apiTokens         ApiToken[]
  invitations       Invitation[]
  knowledgeBases    KnowledgeBase[]
  departments       Department[]
  platformFeedbacks PlatformFeedback[]
  executions        Execution[]
  integrationCredentials IntegrationCredential[]

  @@map("organizations")
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  name                String?
  avatar              String?
  passwordHash        String
  role                Role                 @default(MEMBER)
  isActive            Boolean              @default(true)
  lastLoginAt         DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  organizationId      String
  departmentId        String?
  mustChangePassword  Boolean              @default(false)
  loginAttempts       Int                  @default(0)
  lockedUntil         DateTime?
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department          Department?          @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  workflows           Workflow[]
  executions          Execution[]
  platformFeedbacks   PlatformFeedback[]
  analyticsDataPoints AnalyticsDataPoint[]
  integrationCredentials IntegrationCredential[]

  @@index([organizationId])
  @@index([departmentId])
  @@index([email])
  @@map("users")
}

model IntegrationCredential {
  id                  String   @id @default(cuid())
  provider            String
  accessTokenEncrypted String   @db.Text
  refreshTokenEncrypted String? @db.Text
  expiresAt           DateTime?
  scope               String?  @db.Text
  externalAccountId   String?
  metadata            Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  organizationId      String
  userId              String
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, provider])
  @@index([provider])
  @@index([userId])
  @@map("integration_credentials")
}

model Department {
  id                       String                    @id @default(cuid())
  name                     String
  description              String?                   @db.Text
  sortOrder                Int                       @default(0)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  parentId                 String?
  organizationId           String
  level                    Int                       @default(0)
  managerId                String?
  path                     String                    @default("")
  parent                   Department?               @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children                 Department[]              @relation("DepartmentHierarchy")
  organization             Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users                    User[]
  workflowPermissions      WorkflowPermission[]
  knowledgeBasePermissions KnowledgeBasePermission[]
  invitations              Invitation[]
  analyticsDataPoints      AnalyticsDataPoint[]

  @@index([organizationId])
  @@index([parentId])
  @@index([path])
  @@index([managerId])
  @@map("departments")
}

model Invitation {
  id             String         @id @default(cuid())
  email          String?
  role           Role           @default(MEMBER)
  token          String         @unique
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime       @default(now())
  organizationId String
  invitedById    String?
  maxUses        Int            @default(1)
  type           InvitationType @default(EMAIL)
  usedCount      Int            @default(0)
  departmentId   String?
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department     Department?    @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  @@index([token])
  @@index([organizationId])
  @@index([departmentId])
  @@map("invitations")
}

model ApiKey {
  id             String       @id @default(cuid())
  name           String
  provider       AIProvider
  keyEncrypted   String       @db.Text
  keyMasked      String
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  defaultModel   String       @default("")
  isDefault      Boolean      @default(false)
  baseUrl        String       @default("")
  models         Json
  defaultModels  Json
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("api_keys")
}

model ApiToken {
  id             String       @id @default(cuid())
  name           String
  token          String       @unique
  tokenHash      String       @unique
  prefix         String
  lastUsedAt     DateTime?
  expiresAt      DateTime?
  isActive       Boolean      @default(true)
  scopes         Json
  usageCount     Int          @default(0)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organizationId String
  createdById    String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([tokenHash])
  @@index([prefix])
  @@map("api_tokens")
}

// =========================================================================================
// Workflow Core & Runtime
// =========================================================================================

model Workflow {
  id                  String               @id @default(cuid())
  name                String
  description         String?              @db.Text
  category            String?
  tags                Json
  isActive            Boolean              @default(true)
  isPublic            Boolean              @default(false)
  version             Int                  @default(1)
  config              Json
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  deletedAt           DateTime?
  organizationId      String
  creatorId           String
  analyticsEnabled    Boolean              @default(true)
  currentVersionId    String?
  draftConfig         Json?
  publishStatus       PublishStatus        @default(DRAFT)
  publishedAt         DateTime?
  publishedBy         String?
  publishedConfig     Json?
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  creator             User                 @relation(fields: [creatorId], references: [id])
  executions          Execution[]
  triggers            WorkflowTrigger[]
  permissions         WorkflowPermission[]
  platformFeedbacks   PlatformFeedback[]
  forms               WorkflowForm[]
  versions            WorkflowVersion[]
  analyticsConfigs    AnalyticsConfig[]
  analyticsDashboards AnalyticsDashboard[]
  aiConversations     AIConversation[]

  @@index([organizationId])
  @@index([creatorId])
  @@index([deletedAt])
  @@index([publishStatus])
  @@map("workflows")
}

// =========================================================================================
// AI Assistant Conversations
// =========================================================================================

model AIConversation {
  id         String      @id @default(cuid())
  title      String      @default("新对话")
  workflowId String
  userId     String
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  workflow   Workflow    @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  messages   AIMessage[]

  @@index([workflowId])
  @@index([userId])
  @@index([createdAt])
  @@map("ai_conversations")
}

model AIMessage {
  id             String         @id @default(cuid())
  role           AIMessageRole
  content        String         @db.Text
  phase          String?
  nodeActions    Json?
  testResult     Json?
  pendingFix     Boolean        @default(false)
  fixStatus      String?
  diagnosis      Json?
  suggestions    Json?
  interactiveQuestions Json?
  nodeSelection  Json?
  layoutPreview  Json?
  requirementConfirmation Json?
  createdAt      DateTime       @default(now())
  conversationId String
  conversation   AIConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("ai_messages")
}

enum AIMessageRole {
  user
  assistant
  system
}

model WorkflowPermission {
  id           String               @id @default(cuid())
  permission   PermissionLevel
  targetType   PermissionTargetType
  targetId     String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  workflowId   String
  departmentId String?
  createdById  String
  workflow     Workflow             @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  department   Department?          @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([workflowId, targetType, targetId])
  @@index([workflowId])
  @@index([targetType, targetId])
  @@index([departmentId])
  @@map("workflow_permissions")
}

model WorkflowTrigger {
  id              String       @id @default(cuid())
  name            String
  type            TriggerType
  enabled         Boolean      @default(true)
  webhookPath     String?      @unique
  webhookSecret   String?      @db.Text
  cronExpression  String?
  timezone        String?      @default("Asia/Shanghai")
  inputTemplate   Json?
  retryOnFail     Boolean      @default(false)
  maxRetries      Int          @default(3)
  triggerCount    Int          @default(0)
  lastTriggeredAt DateTime?
  lastSuccessAt   DateTime?
  lastFailureAt   DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  workflowId      String
  createdById     String
  workflow        Workflow     @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  logs            TriggerLog[]

  @@index([workflowId])
  @@index([type])
  @@index([enabled])
  @@index([webhookPath])
  @@map("workflow_triggers")
}

model TriggerLog {
  id             String          @id @default(cuid())
  status         TriggerStatus
  requestMethod  String?
  requestHeaders Json?
  requestBody    Json?
  requestIp      String?
  executionId    String?
  responseCode   Int?
  errorMessage   String?         @db.Text
  triggeredAt    DateTime        @default(now())
  completedAt    DateTime?
  duration       Int?
  triggerId      String
  trigger        WorkflowTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)

  @@index([triggerId])
  @@index([status])
  @@index([triggeredAt])
  @@map("trigger_logs")
}

// =========================================================================================
// Workflow Templates & Marketplace
// =========================================================================================

model WorkflowTemplate {
  id                  String               @id @default(cuid())
  name                String
  description         String?              @db.Text
  category            String
  tags                Json
  thumbnail           String?
  config              Json
  visibility          TemplateVisibility   @default(PRIVATE)
  organizationId      String?
  creatorId           String?
  creatorName         String?
  usageCount          Int                  @default(0)
  rating              Float                @default(0)
  ratingCount         Int                  @default(0)
  isOfficial          Boolean              @default(false)
  version             String               @default("1.0.0")
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  creatorDepartmentId String?
  isHidden            Boolean              @default(false)
  templateType        TemplateType         @default(INTERNAL)
  ratings             TemplateRating[]
  permissions         TemplatePermission[]

  @@index([category])
  @@index([visibility, organizationId])
  @@index([isOfficial])
  @@index([templateType])
  @@index([creatorId])
  @@index([creatorDepartmentId])
  @@map("workflow_templates")
}

model TemplateRating {
  id         String           @id @default(cuid())
  score      Int
  comment    String?          @db.Text
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  templateId String
  userId     String
  userName   String?
  template   WorkflowTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, userId])
  @@index([templateId])
  @@index([userId])
  @@index([score])
  @@map("template_ratings")
}

model TemplatePermission {
  id          String               @id @default(cuid())
  permission  ResourcePermission
  targetType  PermissionTargetType
  targetId    String?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
  templateId  String
  createdById String
  template    WorkflowTemplate     @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, targetType, targetId])
  @@index([templateId])
  @@index([targetType, targetId])
  @@map("template_permissions")
}

model Execution {
  id                  String               @id @default(cuid())
  status              executions_status    @default(PENDING)
  input               Json
  output              Json?
  startedAt           DateTime?
  completedAt         DateTime?
  duration            Int?
  totalTokens         Int                  @default(0)
  promptTokens        Int                  @default(0)
  completionTokens    Int                  @default(0)
  estimatedCost       Decimal?             @db.Decimal(10, 6)
  error               String?              @db.Text
  errorDetail         Json?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  workflowId          String
  userId              String
  canResume           Boolean              @default(false)
  checkpoint          Json?
  lastCheckpoint      DateTime?
  resumedFromId       String?
  workflowVersionId   String?
  organizationId      String
  executionType       ExecutionType        @default(NORMAL)
  isAIGeneratedInput  Boolean              @default(false)
  workflow            Workflow             @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  user                User                 @relation(fields: [userId], references: [id])
  organization        Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  logs                ExecutionLog[]
  outputFiles         OutputFile[]
  feedbacks           ExecutionFeedback[]
  analyticsDataPoints AnalyticsDataPoint[]
  approvalRequests    ApprovalRequest[]
  nodeFeedbacks       NodeTestFeedback[]

  @@index([workflowId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([workflowVersionId])
  @@index([organizationId, createdAt])
  @@index([organizationId, status, createdAt])
  @@index([executionType])
  @@map("executions")
}

model ExecutionLog {
  id               String                  @id @default(cuid())
  nodeId           String
  nodeName         String
  nodeType         execution_logs_nodeType
  input            Json
  output           Json?
  status           execution_logs_status
  aiProvider       AIProvider?
  aiModel          String?
  promptTokens     Int?
  completionTokens Int?
  startedAt        DateTime
  completedAt      DateTime?
  duration         Int?
  error            String?                 @db.Text
  createdAt        DateTime                @default(now())
  executionId      String
  execution        Execution               @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([nodeId])
  @@map("execution_logs")
}

model NodeTestFeedback {
  id            String         @id @default(cuid())
  executionId   String
  nodeId        String
  nodeName      String
  nodeType      String
  isCorrect     Boolean
  errorReason   String?        @db.Text
  errorCategory ErrorCategory?
  nodeOutput    Json?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  userId        String
  execution     Execution      @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([nodeId])
  @@index([isCorrect])
  @@index([errorCategory])
  @@index([createdAt])
  @@map("node_test_feedbacks")
}

model OutputFile {
  id             String       @id @default(cuid())
  fileName       String
  fileKey        String       @unique
  format         OutputFormat
  mimeType       String
  size           Int
  storageType    StorageType  @default(LOCAL)
  url            String?      @db.Text
  downloadCount  Int          @default(0)
  maxDownloads   Int?
  expiresAt      DateTime?
  metadata       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  executionId    String
  nodeId         String
  organizationId String
  execution      Execution    @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([organizationId])
  @@index([fileKey])
  @@index([expiresAt])
  @@map("output_files")
}

// =========================================================================================
// System Audit & logging
// =========================================================================================

model AuditLog {
  id             String   @id @default(cuid())
  action         String
  resource       String
  resourceId     String?
  detail         Json?
  ip             String?
  userAgent      String?  @db.Text
  createdAt      DateTime @default(now())
  userId         String?
  organizationId String?

  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
  @@map("audit_logs")
}

model PlatformAdmin {
  id            String             @id @default(cuid())
  email         String             @unique
  name          String?
  passwordHash  String
  role          PlatformRole       @default(OPERATOR)
  isActive      Boolean            @default(true)
  lastLoginAt   DateTime?
  loginAttempts Int                @default(0)
  lockedUntil   DateTime?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  createdById   String?
  auditLogs     PlatformAuditLog[]

  @@index([email])
  @@map("platform_admins")
}

model PlatformAuditLog {
  id         String        @id @default(cuid())
  action     String
  resource   String
  resourceId String?
  detail     Json?
  ip         String?
  userAgent  String?       @db.Text
  createdAt  DateTime      @default(now())
  adminId    String
  admin      PlatformAdmin @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@index([resource])
  @@index([action])
  @@index([createdAt])
  @@map("platform_audit_logs")
}

// =========================================================================================
// Platform Support & Feedback
// =========================================================================================

model PlatformFeedback {
  id             String                   @id @default(cuid())
  type           PlatformFeedbackType
  title          String
  content        String                   @db.Text
  screenshots    Json?
  source         PlatformFeedbackSource
  workflowId     String?
  executionId    String?
  status         PlatformFeedbackStatus   @default(PENDING)
  priority       PlatformFeedbackPriority @default(NORMAL)
  assignedTo     String?
  reply          String?                  @db.Text
  repliedAt      DateTime?
  resolvedAt     DateTime?
  userId         String
  organizationId String
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  workflow       Workflow?                @relation(fields: [workflowId], references: [id])
  user           User                     @relation(fields: [userId], references: [id])
  organization   Organization             @relation(fields: [organizationId], references: [id])

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@map("platform_feedbacks")
}

model SystemLog {
  id        String   @id @default(cuid())
  level     LogLevel @default(INFO)
  category  String
  message   String   @db.Text
  detail    Json?
  source    String?
  traceId   String?
  createdAt DateTime @default(now())

  @@index([level])
  @@index([category])
  @@index([createdAt])
  @@map("system_logs")
}

// =========================================================================================
// Registration & Applications
// =========================================================================================

model OrgApplication {
  id             String            @id @default(cuid())
  orgName        String
  industry       String?
  website        String?
  phone          String?
  address        String?
  description    String?           @db.Text
  contactName    String
  contactEmail   String
  contactPhone   String?
  status         ApplicationStatus @default(PENDING)
  rejectReason   String?
  reviewedAt     DateTime?
  reviewedById   String?
  organizationId String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([status])
  @@index([contactEmail])
  @@index([createdAt])
  @@map("org_applications")
}

// =========================================================================================
// Password Reset
// =========================================================================================

model PasswordResetToken {
  id        String    @id @default(cuid())
  email     String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([email])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// =========================================================================================
// Knowledge Base (RAG)
// =========================================================================================

model KnowledgeBase {
  id                String                    @id @default(cuid())
  name              String
  description       String?                   @db.Text
  embeddingModel    String                    @default("text-embedding-ada-002")
  embeddingProvider AIProvider                @default(OPENAI)
  chunkSize         Int                       @default(1000)
  chunkOverlap      Int                       @default(200)
  vectorStoreType   VectorStoreType           @default(PGVECTOR)
  vectorStoreConfig Json
  documentCount     Int                       @default(0)
  chunkCount        Int                       @default(0)
  totalSize         Int                       @default(0)
  isActive          Boolean                   @default(true)
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  organizationId    String
  creatorId         String?
  organization      Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  documents         KnowledgeDocument[]
  permissions       KnowledgeBasePermission[]
  bm25IndexCache    BM25IndexCache?

  @@index([organizationId])
  @@index([isActive])
  @@index([creatorId])
  @@map("knowledge_bases")
}

model BM25IndexCache {
  id              String        @id @default(cuid())
  knowledgeBaseId String        @unique
  indexData       String        @db.Text
  documentCount   Int           @default(0)
  termCount       Int           @default(0)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  knowledgeBase   KnowledgeBase @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)

  @@map("bm25_index_cache")
}

model EmbeddingUsage {
  id              String   @id @default(cuid())
  provider        String
  model           String
  tokenCount      Int
  requestCount    Int      @default(1)
  knowledgeBaseId String?
  documentId      String?
  organizationId  String
  createdAt       DateTime @default(now())

  @@index([organizationId])
  @@index([knowledgeBaseId])
  @@index([createdAt])
  @@map("embedding_usage")
}

model KnowledgeBasePermission {
  id              String               @id @default(cuid())
  permission      ResourcePermission
  targetType      PermissionTargetType
  targetId        String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  knowledgeBaseId String
  departmentId    String?
  createdById     String
  knowledgeBase   KnowledgeBase        @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  department      Department?          @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  @@unique([knowledgeBaseId, targetType, targetId])
  @@index([knowledgeBaseId])
  @@index([targetType, targetId])
  @@index([departmentId])
  @@map("knowledge_base_permissions")
}

model KnowledgeDocument {
  id              String           @id @default(cuid())
  fileName        String
  fileType        String
  fileSize        Int
  fileUrl         String?
  fileKey         String?
  status          DocProcessStatus @default(PENDING)
  errorMessage    String?          @db.Text
  chunkCount      Int              @default(0)
  processedAt     DateTime?
  metadata        Json
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  knowledgeBaseId String
  uploadedById    String?
  knowledgeBase   KnowledgeBase    @relation(fields: [knowledgeBaseId], references: [id], onDelete: Cascade)
  chunks          DocumentChunk[]

  @@index([knowledgeBaseId])
  @@index([status])
  @@map("knowledge_documents")
}

model DocumentChunk {
  id          String            @id @default(cuid())
  content     String            @db.Text
  embedding   Json?
  chunkIndex  Int
  startOffset Int?
  endOffset   Int?
  metadata    Json
  createdAt   DateTime          @default(now())
  documentId  String
  document    KnowledgeDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([chunkIndex])
  @@map("document_chunks")
}

model WorkflowVersion {
  id              String      @id @default(cuid())
  versionNumber   Int
  versionTag      String?
  commitMessage   String      @db.Text
  config          Json
  versionType     VersionType @default(MANUAL)
  isPublished     Boolean     @default(false)
  isActive        Boolean     @default(false)
  changesSummary  Json?
  executionCount  Int         @default(0)
  successRate     Float?
  avgRating       Float?
  sourceVersionId String?
  optimizationIds Json?
  createdAt       DateTime    @default(now())
  workflowId      String
  createdById     String
  workflow        Workflow    @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, versionNumber])
  @@index([workflowId])
  @@index([isActive])
  @@index([createdAt])
  @@map("workflow_versions")
}

model ExecutionFeedback {
  id                 String                   @id @default(cuid())
  rating             Int
  isAccurate         Boolean
  expectedOutput     String?                  @db.Text
  actualOutput       String?                  @db.Text
  feedbackComment    String?                  @db.Text
  issueCategories    Json
  aiDiagnosis        Json?
  diagnosedAt        DateTime?
  optimizationStatus OptimizationStatus       @default(PENDING)
  createdAt          DateTime                 @default(now())
  updatedAt          DateTime                 @updatedAt
  executionId        String
  userId             String
  execution          Execution                @relation(fields: [executionId], references: [id], onDelete: Cascade)
  suggestions        OptimizationSuggestion[]

  @@index([executionId])
  @@index([userId])
  @@index([rating])
  @@index([isAccurate])
  @@index([createdAt])
  @@index([optimizationStatus])
  @@map("execution_feedbacks")
}

model OptimizationSuggestion {
  id                 String            @id @default(cuid())
  issueType          IssueCategory
  issueDescription   String            @db.Text
  rootCause          String            @db.Text
  suggestionType     SuggestionType
  suggestionTitle    String
  suggestionDetail   String            @db.Text
  suggestedChanges   Json
  confidence         Float             @default(0.5)
  priority           Int               @default(0)
  status             SuggestionStatus  @default(PENDING)
  appliedAt          DateTime?
  appliedById        String?
  effectivenessScore Float?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  feedbackId         String
  workflowId         String
  feedback           ExecutionFeedback @relation(fields: [feedbackId], references: [id], onDelete: Cascade)

  @@index([feedbackId])
  @@index([workflowId])
  @@index([status])
  @@index([suggestionType])
  @@index([priority])
  @@map("optimization_suggestions")
}

// =========================================================================================
// Analytics & Reporting
// =========================================================================================

model WorkflowAnalytics {
  id               String          @id @default(cuid())
  periodType       AnalyticsPeriod
  periodStart      DateTime
  periodEnd        DateTime
  totalExecutions  Int             @default(0)
  successCount     Int             @default(0)
  failureCount     Int             @default(0)
  cancelledCount   Int             @default(0)
  feedbackCount    Int             @default(0)
  accurateCount    Int             @default(0)
  inaccurateCount  Int             @default(0)
  avgRating        Float?
  issueBreakdown   Json?
  avgDuration      Int?
  avgTokens        Int?
  suggestionsCount Int             @default(0)
  appliedCount     Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  workflowId       String

  @@unique([workflowId, periodType, periodStart])
  @@index([workflowId])
  @@index([periodType])
  @@index([periodStart])
  @@map("workflow_analytics")
}

model WorkflowForm {
  id              String                   @id @default(cuid())
  name            String
  description     String?                  @db.Text
  shareToken      String                   @unique
  isActive        Boolean                  @default(true)
  expiresAt       DateTime?
  maxSubmissions  Int?
  submissionCount Int                      @default(0)
  showResult      Boolean                  @default(true)
  successMessage  String?                  @db.Text
  theme           String                   @default("default")
  mode            FormMode                 @default(FORM)
  stylePrompt     String?                  @db.Text
  htmlTemplate    String?                  @db.LongText
  cssStyles       String?                  @db.LongText
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  workflowId      String
  createdById     String
  workflow        Workflow                 @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  submissions     WorkflowFormSubmission[]

  @@index([workflowId])
  @@index([shareToken])
  @@index([isActive])
  @@map("workflow_forms")
}

model WorkflowFormSubmission {
  id            String               @id @default(cuid())
  inputData     Json
  executionId   String?
  submitterIp   String?
  submitterInfo Json?
  status        FormSubmissionStatus @default(PENDING)
  result        Json?
  errorMessage  String?              @db.Text
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  formId        String
  form          WorkflowForm         @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@index([formId])
  @@index([status])
  @@index([createdAt])
  @@map("workflow_form_submissions")
}

model ApprovalRequest {
  id                String                 @id @default(cuid())
  workflowId        String
  workflowName      String?
  executionId       String
  nodeId            String // 审批节点ID
  title             String
  description       String?                @db.Text
  requestData       Json?
  approvers         Json?
  status            ApprovalStatus         @default(PENDING)
  requiredApprovals Int                    @default(1) // 需要的审批数量
  finalDecision     String? // 'APPROVE' | 'REJECT'
  decidedAt         DateTime? // 最终决定时间
  requestedAt       DateTime? // 请求创建时间
  approvedBy        String?
  approvedAt        DateTime?
  rejectedBy        String?
  rejectedAt        DateTime?
  comment           String?                @db.Text
  expiresAt         DateTime?
  timeoutAction     TimeoutAction?
  customFields      Json? // 自定义表单字段
  inputSnapshot     Json? // 输入数据快照
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  notifications     ApprovalNotification[]
  decisions         ApprovalDecision[]
  execution         Execution?             @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([executionId])
  @@index([nodeId])
  @@index([status])
  @@index([expiresAt])
  @@index([createdAt])
  @@map("approval_requests")
}

model ApprovalDecision {
  id                String          @id @default(cuid())
  decision          String // 'APPROVE' | 'REJECT'
  comment           String?         @db.Text
  customFieldValues Json? // 自定义字段值
  userId            String
  userName          String?
  decidedAt         DateTime        @default(now())
  createdAt         DateTime        @default(now())
  requestId         String
  request           ApprovalRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([userId])
  @@index([decidedAt])
  @@map("approval_decisions")
}

model ApprovalNotification {
  id             String             @id @default(cuid())
  requestId      String
  channel        String             @default("IN_APP") // 'EMAIL' | 'IN_APP' | 'WEBHOOK'
  recipientId    String
  recipientEmail String?
  subject        String?
  content        String?            @db.Text
  status         NotificationStatus @default(PENDING)
  sentAt         DateTime?
  errorMessage   String?            @db.Text
  retryCount     Int                @default(0)
  createdAt      DateTime           @default(now())
  request        ApprovalRequest    @relation(fields: [requestId], references: [id], onDelete: Cascade)

  @@index([requestId])
  @@index([recipientId])
  @@index([status])
  @@map("approval_notifications")
}

model AnalyticsConfig {
  id            String               @id @default(cuid())
  name          String
  label         String
  type          DataPointType
  source        DataSourceType       @default(NODE_OUTPUT)
  sourcePath    String
  nodeId        String?
  nodeName      String?
  aggregation   Json
  visualization VisualizationType    @default(LINE)
  unit          String?
  isActive      Boolean              @default(true)
  isRequired    Boolean              @default(false)
  defaultValue  Json?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  workflowId    String
  workflow      Workflow             @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  dataPoints    AnalyticsDataPoint[]

  @@unique([workflowId, name])
  @@index([workflowId])
  @@index([isActive])
  @@map("analytics_configs")
}

model AnalyticsDataPoint {
  id           String          @id @default(cuid())
  configId     String
  numberValue  Float?
  stringValue  String?
  booleanValue Boolean?
  jsonValue    Json?
  executionId  String
  nodeId       String?
  nodeName     String?
  userId       String
  departmentId String?
  recordedAt   DateTime        @default(now())
  metadata     Json?
  config       AnalyticsConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  execution    Execution       @relation(fields: [executionId], references: [id], onDelete: Cascade)
  user         User            @relation(fields: [userId], references: [id])
  department   Department?     @relation(fields: [departmentId], references: [id])

  @@index([configId])
  @@index([executionId])
  @@index([userId])
  @@index([departmentId])
  @@index([recordedAt])
  @@map("analytics_data_points")
}

model AnalyticsDashboard {
  id             String   @id @default(cuid())
  name           String
  description    String?  @db.Text
  layout         Json
  widgets        Json
  defaultFilters Json?
  isDefault      Boolean  @default(false)
  isPublic       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  workflowId     String
  creatorId      String
  workflow       Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([isDefault])
  @@map("analytics_dashboards")
}

enum OrgStatus {
  PENDING
  ACTIVE
  SUSPENDED
  DISABLED
}

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  MEMBER
  VIEWER
}

enum InvitationType {
  EMAIL
  LINK
}

enum AIProvider {
  SHENSUAN
  OPENROUTER
  OPENAI
  ANTHROPIC
  BAIDU_WENXIN
  ALIYUN_TONGYI
  XUNFEI_SPARK
  STABILITYAI
}

enum PublishStatus {
  DRAFT
  PUBLISHED
  DRAFT_MODIFIED
}

enum PermissionLevel {
  VIEW
  USE
  EDIT
}

enum ResourcePermission {
  VIEWER
  EDITOR
  MANAGER
}

enum PermissionTargetType {
  USER
  DEPARTMENT
  ALL
}

enum TriggerType {
  MANUAL
  WEBHOOK
  SCHEDULE
}

enum TriggerStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  SKIPPED
}

enum TemplateType {
  PUBLIC
  INTERNAL
}

enum TemplateVisibility {
  PRIVATE
  ORGANIZATION
  PUBLIC
}

enum OutputFormat {
  TEXT
  JSON
  MARKDOWN
  HTML
  WORD
  EXCEL
  PDF
  IMAGE
  AUDIO
  VIDEO
}

enum StorageType {
  LOCAL
  ALIYUN_OSS
  AWS_S3
  CUSTOM
}

enum PlatformRole {
  SUPER_ADMIN
  ADMIN
  OPERATOR
  SUPPORT
}

enum PlatformFeedbackType {
  BUG
  FEATURE
  IMPROVEMENT
  ACCURACY
  OTHER
}

enum PlatformFeedbackSource {
  ENTERPRISE
  EMPLOYEE
}

enum PlatformFeedbackStatus {
  PENDING
  PROCESSING
  REPLIED
  RESOLVED
  CLOSED
}

enum PlatformFeedbackPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
  FATAL
}

enum ApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum VectorStoreType {
  PGVECTOR
  PINECONE
  QDRANT
  MILVUS
  MEMORY
}

enum DocProcessStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum VersionType {
  MANUAL
  AUTO_SAVE
  OPTIMIZATION
  ROLLBACK
}

enum OptimizationStatus {
  PENDING
  ANALYZING
  SUGGESTED
  APPLIED
  REJECTED
  INEFFECTIVE
}

enum IssueCategory {
  KNOWLEDGE_BASE
  PROMPT_UNCLEAR
  PROMPT_WRONG
  MODEL_CAPABILITY
  MODEL_CONFIG
  INPUT_QUALITY
  CONTEXT_MISSING
  LOGIC_ERROR
  OTHER
}

enum SuggestionType {
  PROMPT_OPTIMIZATION
  KNOWLEDGE_UPDATE
  MODEL_CHANGE
  MODEL_CONFIG_ADJUST
  ADD_NODE
  REMOVE_NODE
  MODIFY_FLOW
  INPUT_VALIDATION
  OTHER
}

enum SuggestionStatus {
  PENDING
  APPROVED
  APPLIED
  REJECTED
  REVERTED
}

enum AnalyticsPeriod {
  DAILY
  WEEKLY
  MONTHLY
}

enum FormMode {
  FORM
  AI_PAGE
}

enum FormSubmissionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

enum executions_status {
  PENDING
  RUNNING
  PAUSED
  COMPLETED
  FAILED
  CANCELLED
}

enum execution_logs_nodeType {
  TRIGGER
  INPUT
  PROCESS
  CODE
  OUTPUT
  DATA
  IMAGE
  VIDEO
  AUDIO
  CONDITION
  LOOP
  HTTP
  MERGE
  IMAGE_GEN
  NOTIFICATION
}

enum execution_logs_status {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  TIMEOUT
  EXPIRED
  CANCELLED
}

enum TimeoutAction {
  APPROVE
  REJECT
  ESCALATE
  NOTIFY
}

enum NotificationType {
  EMAIL
  SYSTEM
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
}

enum DataPointType {
  NUMBER
  STRING
  BOOLEAN
  ARRAY
  OBJECT
  RATING
  PERCENTAGE
}

enum DataSourceType {
  NODE_OUTPUT
  EXECUTION_META
  USER_FEEDBACK
  CUSTOM
}

enum VisualizationType {
  LINE
  BAR
  PIE
  AREA
  SCATTER
  HEATMAP
  GAUGE
  TABLE
}

enum ExecutionType {
  NORMAL
  TEST
}

enum ErrorCategory {
  OUTPUT_FORMAT
  OUTPUT_CONTENT
  MISSING_DATA
  LOGIC_ERROR
  PERFORMANCE
  OTHER
}
