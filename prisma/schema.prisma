// Prisma Schema for AI Workflow

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

// ============================================
// 企业与用户
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  logo      String?
  plan      Plan     @default(FREE)
  apiQuota  Int      @default(10000)
  apiUsed   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users       User[]
  workflows   Workflow[]
  apiKeys     ApiKey[]
  invitations Invitation[]

  @@map("organizations")
}

enum Plan {
  FREE
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  avatar       String?
  passwordHash String
  role         Role      @default(MEMBER)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  workflows  Workflow[]
  executions Execution[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

enum Role {
  OWNER
  ADMIN
  EDITOR
  MEMBER
  VIEWER
}

model Invitation {
  id         String    @id @default(cuid())
  email      String
  role       Role      @default(MEMBER)
  token      String    @unique
  expiresAt  DateTime
  acceptedAt DateTime?

  createdAt DateTime @default(now())

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([organizationId])
  @@map("invitations")
}

// ============================================
// API Key 管理
// ============================================

model ApiKey {
  id           String     @id @default(cuid())
  name         String
  provider     AIProvider
  baseUrl      String     @default("")  // API 基础地址
  keyEncrypted String     @db.Text
  keyMasked    String
  defaultModel String     @default("")
  models       Json       @default("[]") // 可用模型列表
  isDefault    Boolean    @default(false)
  isActive     Boolean    @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("api_keys")
}

enum AIProvider {
  SHENSUAN
  OPENROUTER
}

// ============================================
// 工作流
// ============================================

model Workflow {
  id          String    @id @default(cuid())
  name        String
  description String?   @db.Text
  category    String?
  tags        Json      @default("[]")
  isActive    Boolean   @default(true)
  isPublic    Boolean   @default(false)
  version     Int       @default(1)

  // 工作流配置 (JSON)
  config Json

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  creatorId String
  creator   User   @relation(fields: [creatorId], references: [id])

  executions Execution[]

  @@index([organizationId])
  @@index([creatorId])
  @@index([deletedAt])
  @@map("workflows")
}

// ============================================
// 执行记录
// ============================================

model Execution {
  id     String          @id @default(cuid())
  status ExecutionStatus @default(PENDING)

  input  Json
  output Json?

  startedAt   DateTime?
  completedAt DateTime?
  duration    Int?

  totalTokens      Int     @default(0)
  promptTokens     Int     @default(0)
  completionTokens Int     @default(0)
  estimatedCost    Decimal? @db.Decimal(10, 6)

  error       String? @db.Text
  errorDetail Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  workflowId String
  workflow   Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  logs        ExecutionLog[]
  outputFiles OutputFile[]

  @@index([workflowId])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("executions")
}

enum ExecutionStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

model ExecutionLog {
  id       String   @id @default(cuid())
  nodeId   String
  nodeName String
  nodeType NodeType

  input  Json
  output Json?
  status ExecutionStatus

  aiProvider       AIProvider?
  aiModel          String?
  promptTokens     Int?
  completionTokens Int?

  startedAt   DateTime
  completedAt DateTime?
  duration    Int?

  error String? @db.Text

  createdAt DateTime @default(now())

  executionId String
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  @@index([executionId])
  @@index([nodeId])
  @@map("execution_logs")
}

enum NodeType {
  INPUT
  PROCESS
  CODE
  OUTPUT
}

// ============================================
// 输出文件
// ============================================

model OutputFile {
  id       String @id @default(cuid())

  // 文件基本信息
  fileName    String              // 原始文件名
  fileKey     String   @unique    // 存储路径/键 (用于云存储)
  format      OutputFormat        // 输出格式
  mimeType    String              // MIME 类型
  size        Int                 // 文件大小 (字节)

  // 存储信息
  storageType StorageType @default(LOCAL)  // 存储类型
  url         String?     @db.Text         // 完整访问 URL

  // 下载控制
  downloadCount Int       @default(0)      // 下载次数
  maxDownloads  Int?                       // 最大下载次数限制
  expiresAt     DateTime?                  // 过期时间

  // 元数据
  metadata Json?                           // 额外元数据 (如图片尺寸、视频时长等)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // 关联
  executionId String
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)

  nodeId String                            // 生成此文件的节点 ID

  organizationId String

  @@index([executionId])
  @@index([organizationId])
  @@index([fileKey])
  @@index([expiresAt])
  @@map("output_files")
}

enum OutputFormat {
  TEXT
  JSON
  MARKDOWN
  HTML
  WORD
  EXCEL
  PDF
  IMAGE
  AUDIO
  VIDEO
}

enum StorageType {
  LOCAL       // 本地存储
  ALIYUN_OSS  // 阿里云 OSS
  AWS_S3      // AWS S3
  CUSTOM      // 自定义存储
}

// ============================================
// 审计日志
// ============================================

model AuditLog {
  id         String  @id @default(cuid())
  action     String
  resource   String
  resourceId String?
  detail     Json?
  ip         String?
  userAgent  String? @db.Text

  createdAt DateTime @default(now())

  userId         String?
  organizationId String?

  @@index([userId])
  @@index([organizationId])
  @@index([createdAt])
  @@map("audit_logs")
}
