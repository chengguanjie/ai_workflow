# AI Workflow 增强计划

> 参考 n8n 2.0 五大特性，结合项目现状制定的升级路线图

## 项目现状概览

| 维度 | 当前状态 |
|------|----------|
| 技术栈 | Next.js 15 + React 19 + Prisma + MySQL + Redis |
| 节点类型 | 23+ 种处理器 |
| 代码执行 | Pyodide (浏览器端 Python) |
| 版本管理 | 已有基础版本控制 |
| 队列系统 | BullMQ + Redis |
| AI 集成 | 8+ 个模型提供商 |

---

## 一、安全沙盒化：代码节点隔离升级

### 1.1 现状分析

**当前实现：**
- 代码执行使用 Pyodide（浏览器端 WebAssembly）
- 位置：`src/lib/code-executor/pyodide-executor.ts`
- 仅支持 Python，在客户端浏览器中运行

**存在问题：**
- 无服务端代码执行能力
- 缺乏进程级隔离
- 无法限制 CPU/内存使用
- 不支持 JavaScript/Node.js 服务端执行

### 1.2 增强方案

#### 阶段一：服务端沙盒执行器（优先级：高）

```
目标：实现类似 n8n Task Runners 的隔离执行环境
```

**技术方案：**

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| Docker 容器 | 完全隔离、支持多语言 | 部署复杂、启动慢 | ★★★★☆ |
| VM2 沙盒 | 轻量、快速 | 仅 Node.js、安全性一般 | ★★★☆☆ |
| Worker Threads | 原生支持、性能好 | 隔离程度有限 | ★★★☆☆ |
| isolated-vm | V8 隔离、安全性高 | 仅 JS、学习成本 | ★★★★★ |

**推荐实现路径：**

```typescript
// 新建 src/lib/code-executor/task-runner.ts

interface TaskRunner {
  // 配置
  maxExecutionTime: number;    // 最大执行时间 (ms)
  maxMemory: number;           // 最大内存 (MB)
  allowedModules: string[];    // 允许的模块白名单

  // 方法
  execute(code: string, context: object): Promise<ExecutionResult>;
  terminate(): void;
}

// 执行结果
interface ExecutionResult {
  success: boolean;
  output: any;
  logs: string[];
  metrics: {
    executionTime: number;
    memoryUsed: number;
  };
  error?: string;
}
```

**实现任务：**

- [ ] 1.2.1 设计 Task Runner 抽象接口
- [ ] 1.2.2 实现 isolated-vm 执行器（JavaScript）
- [ ] 1.2.3 实现 Docker 执行器（Python/多语言）
- [ ] 1.2.4 添加资源限制配置（CPU/内存/时间）
- [ ] 1.2.5 实现执行队列，防止并发过载
- [ ] 1.2.6 添加安全审计日志

#### 阶段二：环境变量安全管理

**新增功能：**

- [ ] 1.2.7 敏感变量加密存储
- [ ] 1.2.8 代码节点变量注入白名单
- [ ] 1.2.9 变量访问审计记录

**数据库变更：**

```prisma
model SecureVariable {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  encryptedValue String   @db.Text
  scope          VariableScope @default(WORKFLOW)
  allowedNodes   String[] // 允许访问的节点类型
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization   Organization @relation(fields: [organizationId], references: [id])

  @@unique([organizationId, name])
}

enum VariableScope {
  GLOBAL      // 全局可用
  WORKFLOW    // 工作流级别
  NODE        // 节点级别
}
```

---

## 二、发布模式重构：Draft/Published 双状态

### 2.1 现状分析

**当前实现：**
- 已有 `WorkflowVersion` 表支持版本管理
- 版本类型：`MANUAL`, `AUTO_SAVE`, `OPTIMIZATION`, `ROLLBACK`
- 支持版本对比和回滚

**存在问题：**
- 保存即生效，无草稿/发布分离
- 生产环境调试风险高
- 缺乏版本发布审批流程

### 2.2 增强方案

#### 阶段一：双状态机制（优先级：高）

**数据库变更：**

```prisma
model Workflow {
  // ... 现有字段

  // 新增字段
  draftConfig      Json?     // 草稿配置
  publishedConfig  Json?     // 已发布配置
  publishedAt      DateTime? // 最后发布时间
  publishedBy      String?   // 发布者ID
  status           WorkflowStatus @default(DRAFT)
}

enum WorkflowStatus {
  DRAFT           // 仅有草稿
  PUBLISHED       // 已发布
  DRAFT_MODIFIED  // 已发布但有未发布的修改
}
```

**UI 变更：**

```
┌─────────────────────────────────────────────────────┐
│  工作流编辑器                                        │
├─────────────────────────────────────────────────────┤
│                                                      │
│  [状态标签: 草稿有修改 ●]                            │
│                                                      │
│  ┌──────────────────────────────────────────────┐  │
│  │                                               │  │
│  │         工作流画布                            │  │
│  │                                               │  │
│  └──────────────────────────────────────────────┘  │
│                                                      │
│  ┌────────────┐  ┌────────────┐  ┌──────────────┐  │
│  │   保存草稿  │  │  预览/测试  │  │  发布到生产  │  │
│  └────────────┘  └────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────┘
```

**实现任务：**

- [ ] 2.2.1 添加 `draftConfig` 和 `publishedConfig` 字段
- [ ] 2.2.2 修改保存逻辑：保存到 `draftConfig`
- [ ] 2.2.3 实现发布功能：`draftConfig` → `publishedConfig`
- [ ] 2.2.4 修改执行逻辑：使用 `publishedConfig`（生产）或 `draftConfig`（测试）
- [ ] 2.2.5 添加状态指示器组件
- [ ] 2.2.6 实现草稿/发布版本对比视图

#### 阶段二：发布审批流程（优先级：中）

**适用场景：** 企业版高级功能

- [ ] 2.2.7 设计审批流程配置
- [ ] 2.2.8 实现审批请求和审批操作
- [ ] 2.2.9 添加审批通知（邮件/Webhook）
- [ ] 2.2.10 审批历史记录

---

## 三、Human-in-the-Loop：人机协作增强

### 3.1 现状分析

**当前实现：**
- 已有断点续执功能：`src/lib/workflow/checkpoint.ts`
- 支持工作流暂停和恢复
- 执行状态：`PENDING`, `RUNNING`, `PAUSED`, `COMPLETED`, `FAILED`

**存在问题：**
- 缺乏专门的人工审批节点
- 暂停后的数据传递不够灵活
- 无法在子工作流中等待人工确认

### 3.2 增强方案

#### 阶段一：人工审批节点（优先级：高）

**新增节点类型：`approval`**

```typescript
// src/lib/workflow/processors/approval.ts

interface ApprovalNodeConfig {
  title: string;
  description: string;
  approvers: ApproverConfig[];
  timeout: number;              // 超时时间（小时）
  timeoutAction: 'reject' | 'approve' | 'escalate';
  notificationChannels: NotificationChannel[];
  requiredApprovals: number;    // 需要的批准数量
  allowComments: boolean;
  customFields: CustomField[];  // 自定义表单字段
}

interface ApprovalResult {
  status: 'approved' | 'rejected' | 'timeout';
  approvedBy: string[];
  rejectedBy: string[];
  comments: string;
  customFieldValues: Record<string, any>;
  decidedAt: Date;
}
```

**数据库变更：**

```prisma
model ApprovalRequest {
  id             String   @id @default(cuid())
  executionId    String
  nodeId         String
  title          String
  description    String?  @db.Text
  status         ApprovalStatus @default(PENDING)
  requestedAt    DateTime @default(now())
  expiresAt      DateTime?
  decidedAt      DateTime?

  // 关联
  execution      Execution @relation(fields: [executionId], references: [id])
  decisions      ApprovalDecision[]

  @@index([executionId])
  @@index([status])
}

model ApprovalDecision {
  id              String   @id @default(cuid())
  requestId       String
  userId          String
  decision        ApprovalDecisionType
  comment         String?  @db.Text
  customFields    Json?
  decidedAt       DateTime @default(now())

  request         ApprovalRequest @relation(fields: [requestId], references: [id])
  user            User @relation(fields: [userId], references: [id])
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  TIMEOUT
  CANCELLED
}

enum ApprovalDecisionType {
  APPROVE
  REJECT
}
```

**实现任务：**

- [ ] 3.2.1 创建 `ApprovalRequest` 和 `ApprovalDecision` 数据模型
- [ ] 3.2.2 实现审批节点处理器
- [ ] 3.2.3 创建审批待办页面 `/approvals`
- [ ] 3.2.4 实现审批通知（邮件、站内信）
- [ ] 3.2.5 审批超时自动处理
- [ ] 3.2.6 审批结果注入后续节点

#### 阶段二：等待节点增强（优先级：中）

**增强 Wait 节点功能：**

```typescript
interface WaitNodeConfig {
  waitType: 'time' | 'webhook' | 'approval' | 'event';

  // 时间等待
  duration?: number;
  unit?: 'seconds' | 'minutes' | 'hours' | 'days';

  // Webhook 等待
  webhookPath?: string;
  webhookSecret?: string;

  // 事件等待
  eventName?: string;
  eventFilter?: object;

  // 通用配置
  timeout: number;
  timeoutAction: 'continue' | 'fail' | 'skip';
  resumeData?: 'merge' | 'replace' | 'append';
}
```

- [ ] 3.2.7 实现多种等待类型
- [ ] 3.2.8 子工作流等待节点支持
- [ ] 3.2.9 等待状态可视化
- [ ] 3.2.10 等待事件日志

---

## 四、性能与 UI 优化

### 4.1 现状分析

**当前性能状况：**
- 使用 Zustand 状态管理
- XFlow 工作流画布
- React Query 数据获取
- 无明确的性能优化策略

**UI 状况：**
- Radix UI + Tailwind CSS
- 基础的工作流编辑器

### 4.2 增强方案

#### 阶段一：保存性能优化（优先级：高）

**目标：实现毫秒级保存响应**

**技术方案：**

```typescript
// src/stores/workflow-store.ts 增强

interface OptimisticUpdate {
  // 乐观更新策略
  saveLocal: () => void;           // 立即更新本地状态
  syncRemote: () => Promise<void>; // 后台同步远程
  rollback: () => void;            // 失败回滚
}

// 防抖保存
const debouncedSave = useDebouncedCallback(
  async (workflow) => {
    await saveWorkflow(workflow);
  },
  { wait: 1000, leading: false, trailing: true }
);

// 自动保存指示器
interface AutoSaveState {
  status: 'saved' | 'saving' | 'error' | 'offline';
  lastSavedAt: Date | null;
  pendingChanges: boolean;
}
```

**实现任务：**

- [ ] 4.2.1 实现乐观更新机制
- [ ] 4.2.2 添加防抖自动保存
- [ ] 4.2.3 创建保存状态指示器组件
- [ ] 4.2.4 离线支持（IndexedDB 缓存）
- [ ] 4.2.5 冲突检测和解决

#### 阶段二：UI 现代化（优先级：中）

**画布优化：**

```
设计目标：
┌─────────────────────────────────────────────────────┐
│  • 节点样式现代化：移除粗白边，采用柔和阴影          │
│  • 连线优化：加粗连线，支持高亮选中                  │
│  • 动画效果：节点拖拽、连接的流畅动画               │
│  • 小地图：大型工作流快速导航                       │
│  • 快捷键：复制/粘贴/撤销/重做                      │
└─────────────────────────────────────────────────────┘
```

**实现任务：**

- [ ] 4.2.6 节点样式重设计
- [ ] 4.2.7 连线样式优化
- [ ] 4.2.8 添加工作流小地图
- [ ] 4.2.9 实现快捷键系统
- [ ] 4.2.10 拖拽动画优化

#### 阶段三：侧边栏重组（优先级：中）

**当前侧边栏结构 → 优化后结构：**

```
当前                          优化后
├── 节点面板                   ├── 🔍 快速搜索
├── 工作流列表                 ├── 📦 节点面板（分类优化）
└── 设置                       │   ├── 触发器
                               │   ├── AI 处理
                               │   ├── 数据处理
                               │   ├── 集成
                               │   └── 高级
                               ├── 📋 最近使用
                               ├── ⭐ 收藏节点
                               └── ⚙️ 工作流设置
```

- [ ] 4.2.11 侧边栏结构重组
- [ ] 4.2.12 快速搜索功能
- [ ] 4.2.13 节点收藏功能
- [ ] 4.2.14 最近使用记录

---

## 五、架构做减法：精简与聚焦

### 5.1 现状分析

**当前技术债务：**
- 数据库：MySQL（主）+ PostgreSQL（向量存储可选）
- 存储：本地 + 阿里云 OSS
- 多个 AI 提供商集成

### 5.2 增强方案

#### 阶段一：数据库统一（优先级：低）

**评估选项：**

| 选项 | 描述 | 工作量 | 推荐 |
|------|------|--------|------|
| 保持现状 | MySQL + 可选 PostgreSQL | 无 | ✓ 短期 |
| 迁移 PostgreSQL | 全面迁移到 PostgreSQL | 高 | ✓ 长期 |

**PostgreSQL 优势：**
- 原生 JSON 支持更强
- pgvector 向量存储
- 更好的并发性能
- n8n 2.0 的选择

**实现任务（长期）：**

- [ ] 5.2.1 评估迁移可行性
- [ ] 5.2.2 创建迁移脚本
- [ ] 5.2.3 数据兼容性测试
- [ ] 5.2.4 生产环境迁移计划

#### 阶段二：清理遗留代码（优先级：中）

**需要审查的区域：**

- [ ] 5.2.5 检查未使用的 API 路由
- [ ] 5.2.6 清理废弃的组件
- [ ] 5.2.7 移除未使用的依赖
- [ ] 5.2.8 优化 bundle 大小

#### 阶段三：存储统一（优先级：低）

**方案：** 抽象存储接口，支持多后端

```typescript
// src/lib/storage/interface.ts

interface StorageProvider {
  upload(file: Buffer, path: string): Promise<string>;
  download(path: string): Promise<Buffer>;
  delete(path: string): Promise<void>;
  getUrl(path: string, expiry?: number): Promise<string>;
  exists(path: string): Promise<boolean>;
}

// 已有实现
// - LocalStorageProvider
// - AliyunOSSProvider

// 可扩展
// - S3Provider
// - GCSProvider
```

- [ ] 5.2.9 统一存储接口
- [ ] 5.2.10 添加存储配置 UI

---

## 六、实施路线图

### Phase 1: 核心升级（1-2 个月）

| 优先级 | 功能 | 预估工作量 |
|--------|------|-----------|
| P0 | Draft/Published 双状态机制 | 2 周 |
| P0 | 服务端代码沙盒执行 | 2 周 |
| P0 | 保存性能优化（乐观更新） | 1 周 |
| P1 | 人工审批节点 | 2 周 |

### Phase 2: 体验优化（1 个月）

| 优先级 | 功能 | 预估工作量 |
|--------|------|-----------|
| P1 | UI 现代化（节点/连线样式） | 2 周 |
| P1 | 侧边栏重组 | 1 周 |
| P2 | 快捷键系统 | 1 周 |

### Phase 3: 高级功能（1-2 个月）

| 优先级 | 功能 | 预估工作量 |
|--------|------|-----------|
| P2 | 发布审批流程 | 2 周 |
| P2 | 等待节点增强 | 1 周 |
| P2 | 离线支持 | 2 周 |
| P3 | 数据库迁移评估 | 1 周 |

---

## 七、风险与依赖

### 技术风险

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 沙盒执行器性能 | 代码节点变慢 | 性能基准测试，多方案对比 |
| 数据库迁移 | 数据丢失 | 完整备份，渐进迁移 |
| 状态管理复杂度 | Draft/Published 逻辑混乱 | 清晰的状态机设计 |

### 外部依赖

- isolated-vm 或 Docker 环境
- Redis 稳定性
- 第三方 AI 服务可用性

---

## 八、成功指标

| 指标 | 当前基线 | 目标 |
|------|----------|------|
| 保存响应时间 | ~500ms | <100ms |
| 代码执行隔离 | 无 | 100% 隔离 |
| 发布事故率 | - | 降低 80% |
| 人工审批支持 | 无 | 完整支持 |
| UI 满意度 | - | 提升 30% |

---

## 附录：参考资源

- [n8n 2.0 Release Notes](https://n8n.io/blog/)
- [isolated-vm 文档](https://github.com/laverdet/isolated-vm)
- [BullMQ 最佳实践](https://docs.bullmq.io/)
- [Prisma 迁移指南](https://www.prisma.io/docs/guides/migrate)

---

*文档版本: 1.0*
*创建日期: 2024-12-21*
*基于: n8n 2.0 特性分析*
