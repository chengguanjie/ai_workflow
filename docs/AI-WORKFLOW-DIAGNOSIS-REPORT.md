# AI-Workflow 产品诊断报告与开发计划

**诊断日期**: 2026年1月1日  
**版本**: v1.0  
**诊断范围**: 7大核心功能模块

---

## 一、总体评估概览

### 产品成熟度总览

| 功能模块 | 完成度 | 状态 | 优先级 |
|---------|-------|------|-------|
| 1. 调用工具（平台工具集成） | 65% | 🟡 需完善 | P0 |
| 2. AI规划功能（一键创建工作流） | 85% | 🟢 基本完整 | P1 |
| 3. 多模态功能 | 85% | 🟢 基本完整 | P1 |
| 4. 工作流统计分析 | 95% | 🟢 完整 | P2 |
| 5. 核心模板库 | 90% | 🟢 完整 | P2 |
| 6. 账号登录管理 | 95% | 🟢 完整 | P3 |
| 7. 知识库检索 | 95% | 🟢 完整 | P3 |

**整体评分**: ★★★★☆ (86/100)

---

## 二、各模块详细诊断

### 2.1 调用工具功能

#### 实现现状

| 工具名称 | 实现状态 | 完整性 | 测试覆盖 | 关键缺陷 |
|---------|---------|--------|---------|---------|
| HTTP请求 | ✅ 完整 | 100% | ❌ 无 | 无 |
| 飞书多维表格 | ✅ 完整 | 95% | ❌ 无 | 缺少批量操作 |
| 微信公众号 | ✅ 完整 | 90% | ✅ 有 | 无 |
| 抖音 | ⚠️ 基础 | 40% | ✅ 有 | 仅发布功能 |
| 视频号 | ⚠️ 基础 | 40% | ✅ 有 | 仅发布功能 |
| 小红书 | ⚠️ 基础 | 35% | ✅ 有 | 仅发布功能 |

#### 核心问题

1. **平台工具未注册到工具索引** (高优先级)
   - 位置: `src/lib/ai/function-calling/executors/index.ts`
   - 影响: 抖音、视频号、小红书工具无法被工作流调用

2. **OAuth流程不完整**
   - 抖音、视频号、小红书依赖环境变量而非动态OAuth
   - 缺少Token自动刷新机制

3. **功能缺失**
   - 抖音: 缺少视频上传、草稿管理、定时发布
   - 视频号: 缺少素材管理、发布状态查询
   - 小红书: 缺少话题/标签管理、内容审核状态

---

### 2.2 AI规划功能（一键创建工作流）

#### 实现现状

| 子功能 | 状态 | 完整性 | 位置 |
|-------|------|--------|------|
| 创建工作流 | ✅ 完整 | 90% | `/api/ai-assistant/create-workflow` |
| 诊断功能 | ✅ 完整 | 85% | `/api/ai-assistant/diagnose` |
| 优化功能 | ✅ 完整 | 85% | `/api/ai-assistant/optimize` |
| 精修功能 | ✅ 完整 | 80% | `/api/ai-assistant/refine` |

#### 核心问题

1. **JSON解析容错有限** (高优先级)
   - AI响应格式不规范时解析失败
   - 建议: 增加更宽松的JSON修复算法

2. **节点数据结构不一致**
   - `node.data` vs `node.config` 访问方式不统一
   - 影响: 诊断/优化功能可能获取错误数据

3. **URL占位符配置问题**
   - HTTP工具接受`{{请配置}}`这样的占位符
   - 影响: 工作流执行时失败

4. **缺失功能**
   - 修改冲突检测（多操作组合时）
   - 撤销/重做功能
   - 优化方案可视化对比

---

### 2.3 多模态功能

#### 实现现状

| 模态类型 | 状态 | 支持模型数 | 完整性 |
|---------|------|-----------|--------|
| 图片生成 | ✅ 完整 | 10+ | 90% |
| 视频生成 | ✅ 完整 | 4 | 80% |
| 音频TTS | ✅ 完整 | 2 | 90% |
| 音频转录 | ✅ 完整 | 2 | 90% |
| 代码执行 | ✅ 完整 | JS/TS | 80% |
| 向量嵌入 | ✅ 完整 | 5 | 95% |
| OCR识别 | ✅ 完整 | 2 | 85% |

#### 核心问题

1. **Process节点多模态支持局限** (高优先级)
   - PROCESS节点将图片等数据仅作为字符串处理
   - GPT-4o、Claude等多模态模型无法发挥视觉能力

2. **模型能力定义分散**
   - 各节点有多个硬编码的`*_MODELS`列表
   - 维护成本高，容易不一致

3. **缺失功能**
   - Python/SQL代码执行
   - 图生图功能
   - 视频帧提取和理解

---

### 2.4 工作流统计分析

#### 实现现状

| 功能 | 状态 | 完整性 |
|-----|------|--------|
| 执行统计 | ✅ 完整 | 100% |
| 成本分析 | ✅ 完整 | 100% |
| 节点性能 | ✅ 完整 | 100% |
| 用户反馈 | ✅ 完整 | 100% |
| 自定义数据点 | ✅ 完整 | 95% |
| 仪表板管理 | ✅ 完整 | 95% |
| 诊断分析器 | ✅ 完整 | 90% |
| 自动优化器 | ✅ 完整 | 90% |

#### 支持的统计指标

- **执行指标**: 成功率、耗时、Token数、趋势分析
- **成本指标**: 14个模型定价、按模型分解、成本趋势
- **反馈指标**: 1-5评分、准确度、9种问题分类

#### 待优化项

1. 缺少WebSocket实时推送（当前3秒轮询）
2. 缺少数据导出功能（CSV/PDF）
3. 缺少告警规则配置
4. 缺少版本间对比分析

---

### 2.5 核心模板库

#### 实现现状

**总模板数**: 61个官方模板

| 分类 | 模板数 | 完整性 | 关键模板 |
|------|-------|--------|---------|
| 销售 | 10 | ⭐⭐⭐⭐⭐ | 线索评估、邮件秘书、KA背调、投标书 |
| 人力资源 | 9 | ⭐⭐⭐⭐⭐ | 招聘、入职、离职预测、人才盘点 |
| 运营 | 8 | ⭐⭐⭐⭐⭐ | 客服自动化、危机公关、选品定价 |
| 行政 | 6 | ⭐⭐⭐⭐⭐ | 会议追踪、周报聚合、差旅优化 |
| 财务 | 5 | ⭐⭐⭐⭐⭐ | BI分析、风险雷达、发票稽核 |
| 市场 | 4 | ⭐⭐⭐⭐ | 竞品分析、品牌联名、ROI归因 |
| 法务 | 4 | ⭐⭐⭐⭐⭐ | 合同审查、IP维权、GDPR审计 |
| 技术研发 | 3 | ⭐⭐⭐⭐ | 代码审计、DevOps自愈、测试用例 |
| 新媒体 | 2 | ⭐⭐⭐ | 爆文引擎、多平台发布 |
| 其他 | 10 | ⭐⭐⭐⭐ | 采购、生产、产品等 |

#### 核心问题

1. **新媒体模板数量不足**
   - 仅2个模板，缺少短视频脚本、直播带货等
   
2. **缺失场景**
   - 销售佣金计算
   - 客服工单智能分配
   - 用户画像分析

---

### 2.6 账号登录管理

#### 实现现状

| 功能 | 状态 | 完整性 |
|-----|------|--------|
| 邮箱/手机登录 | ✅ 完整 | 100% |
| 密码管理 | ✅ 完整 | 100% |
| 账户安全 | ✅ 完整 | 95% |
| 成员管理 | ✅ 完整 | 95% |
| 邀请系统 | ✅ 完整 | 95% |
| OAuth集成 | ✅ 部分 | 70% |

#### OAuth支持情况

| 平台 | OAuth支持 | Token管理 | 状态 |
|-----|----------|----------|------|
| 小红书 | ✅ 是 | 加密存储 | 完整 |
| 抖音 | ✅ 是 | 加密存储 | 完整 |
| 视频号 | ✅ 是 | 加密存储 | 完整 |
| 微信公众号 | ❌ 否 | 环境变量 | 待完善 |

#### 待优化项

1. 两因素认证(2FA)未实现
2. 社交登录（GitHub/Google）未实现
3. SAML/LDAP企业集成未实现

---

### 2.7 知识库检索

#### 实现现状

| 功能 | 状态 | 完整性 |
|-----|------|--------|
| 向量搜索 | ✅ 完整 | 100% |
| 关键词搜索(BM25) | ✅ 完整 | 100% |
| 混合搜索 | ✅ 完整 | 100% |
| 跨知识库搜索 | ✅ 完整 | 100% |
| 查询增强 | ✅ 完整 | 90% |
| 重排序 | ✅ 完整 | 95% |
| 工作流集成 | ✅ 完整 | 100% |
| 权限控制 | ✅ 完整 | 95% |

#### 向量存储后端

| 后端 | 状态 | 适用场景 |
|-----|------|---------|
| Supabase | ✅ 实现 | 云端存储 |
| PgVector | ✅ 实现 | 本地部署 |
| 内存存储 | ✅ 实现 | 开发测试 |
| Pinecone | ❌ 未实现 | 计划中 |
| Qdrant | ❌ 未实现 | 计划中 |

#### 核心特性

- 多层级降级: 向量存储 → 内存 → 关键词搜索
- 父子分块策略: Index Small, Retrieve Big
- 5分钟BM25索引缓存
- 企业级权限控制

---

## 三、关键问题优先级排序

### 🔴 P0 - 阻塞性问题（需立即修复）

| 编号 | 问题 | 影响范围 | 位置 |
|-----|------|---------|------|
| P0-1 | 平台工具未注册到工具索引 | 抖音/视频号/小红书无法调用 | `executors/index.ts` |
| P0-2 | Process节点多模态支持不完整 | 视觉模型能力受限 | `modality-router.ts` |
| P0-3 | 节点数据结构不一致(data vs config) | 诊断/优化功能异常 | 多处 |
| P0-4 | URL占位符配置导致执行失败 | 创建的工作流无法运行 | `create-workflow/route.ts` |

### 🟡 P1 - 重要问题（1-2周内修复）

| 编号 | 问题 | 影响范围 | 位置 |
|-----|------|---------|------|
| P1-1 | 抖音/视频号/小红书功能不完整 | 新媒体场景受限 | `executors/` |
| P1-2 | OAuth Token自动刷新缺失 | 长期运行工作流失败 | `credentials.ts` |
| P1-3 | JSON解析容错不足 | AI生成工作流失败 | `create-workflow/route.ts` |
| P1-4 | 缺少Python代码执行 | 复杂计算场景受限 | `code-execution/` |
| P1-5 | 新媒体模板数量不足 | 新媒体用户体验差 | `official-templates.ts` |

### 🟢 P2 - 优化项（1个月内完成）

| 编号 | 问题 | 影响范围 |
|-----|------|---------|
| P2-1 | 修改冲突检测缺失 | 精修功能可靠性 |
| P2-2 | 撤销/重做功能缺失 | 用户体验 |
| P2-3 | 优化方案可视化对比 | 优化决策效率 |
| P2-4 | 统一模型能力定义 | 代码维护性 |
| P2-5 | 实时推送替代轮询 | 系统性能 |

---

## 四、开发计划

### 第一阶段：修复阻塞性问题（第1-2周）

#### Week 1: 工具集成修复

- [ ] **任务1**: 注册平台工具到工具索引
  - 修改 `src/lib/ai/function-calling/executors/index.ts`
  - 导出并注册 DouyinVideoToolExecutor、WechatChannelsToolExecutor、XiaohongshuToolExecutor
  
- [ ] **任务2**: 统一节点数据结构
  - 全局搜索 `node.data` 和 `node.config` 使用情况
  - 统一为 `node.config` 访问方式
  - 更新类型定义

- [ ] **任务3**: 修复URL占位符问题
  - 在 `enrichToolConfig` 中增加占位符检测
  - 抛出明确错误提示用户配置

#### Week 2: 多模态增强

- [ ] **任务4**: 增强Process节点多模态支持
  - 修改 `modality-router.ts`
  - 支持图片/视频输入的视觉理解
  - 为多模态模型自动构建正确的消息格式

- [ ] **任务5**: 增强JSON解析容错
  - 添加多种JSON修复策略
  - 支持常见格式错误的自动修复

### 第二阶段：功能完善（第3-4周）

#### Week 3: 平台工具增强

- [ ] **任务6**: 完善抖音工具
  - 添加视频上传功能
  - 添加草稿管理
  - 添加定时发布

- [ ] **任务7**: 完善视频号工具
  - 添加素材管理
  - 添加发布状态查询

- [ ] **任务8**: 完善小红书工具
  - 添加话题/标签管理
  - 添加内容审核状态查询

#### Week 4: 代码执行与模板

- [ ] **任务9**: 添加Python代码执行
  - 集成Python沙箱环境
  - 支持常用数据分析库

- [ ] **任务10**: 扩充新媒体模板
  - 短视频脚本生成模板
  - 直播带货脚本模板
  - 内容热度预测模板
  - 粉丝互动运营模板

### 第三阶段：体验优化（第5-6周）

#### Week 5: AI助手增强

- [ ] **任务11**: 添加修改冲突检测
  - 分析操作间依赖关系
  - 提示用户潜在冲突

- [ ] **任务12**: 添加撤销/重做功能
  - 实现操作历史栈
  - 支持回滚到任意版本

- [ ] **任务13**: 优化方案可视化对比
  - 添加方案对比界面
  - 支持差异高亮显示

#### Week 6: 系统优化

- [ ] **任务14**: 统一模型能力定义
  - 创建 `src/lib/ai/model-capabilities.ts`
  - 集中管理所有模型能力定义

- [ ] **任务15**: OAuth Token自动刷新
  - 实现Token过期前自动刷新
  - 添加刷新失败告警

- [ ] **任务16**: 实时推送替代轮询
  - 集成WebSocket
  - 执行状态实时推送

### 第四阶段：扩展功能（第7-8周）

#### Week 7: 知识库扩展

- [ ] **任务17**: 集成Pinecone向量存储
- [ ] **任务18**: 集成Qdrant向量存储
- [ ] **任务19**: 启用Query Expansion功能

#### Week 8: 账号安全增强

- [ ] **任务20**: 实现两因素认证(2FA)
- [ ] **任务21**: 添加社交登录（GitHub/Google）
- [ ] **任务22**: 统计分析数据导出（CSV/PDF）

---

## 五、资源评估

### 开发资源需求

| 阶段 | 周期 | 前端工作量 | 后端工作量 | 测试工作量 |
|-----|-----|-----------|-----------|-----------|
| 第一阶段 | 2周 | 3人天 | 8人天 | 4人天 |
| 第二阶段 | 2周 | 5人天 | 10人天 | 5人天 |
| 第三阶段 | 2周 | 8人天 | 6人天 | 4人天 |
| 第四阶段 | 2周 | 4人天 | 10人天 | 5人天 |
| **总计** | **8周** | **20人天** | **34人天** | **18人天** |

### 技术依赖

| 功能 | 依赖项 | 状态 |
|-----|-------|------|
| Python代码执行 | Python沙箱（如Pyodide） | 需调研 |
| 实时推送 | WebSocket/Socket.io | 可用 |
| Pinecone集成 | @pinecone-database/pinecone | 需安装 |
| Qdrant集成 | @qdrant/js-client-rest | 需安装 |
| 2FA认证 | otplib | 需安装 |

---

## 六、风险评估

### 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|-----|-----|-----|---------|
| Python沙箱安全性 | 中 | 高 | 使用成熟方案如Pyodide |
| 平台API变更 | 中 | 中 | 添加API版本检测和适配层 |
| OAuth流程复杂性 | 低 | 中 | 完善错误处理和用户引导 |

### 业务风险

| 风险 | 概率 | 影响 | 缓解措施 |
|-----|-----|-----|---------|
| 新媒体平台限流 | 高 | 中 | 实现请求队列和限流控制 |
| 模型能力变化 | 中 | 低 | 定期更新模型能力定义 |

---

## 七、验收标准

### 功能验收

1. **工具调用**: 6个平台工具全部可在工作流中正常调用
2. **AI规划**: 一键创建工作流成功率 > 90%
3. **多模态**: 图片/视频/音频/代码全链路可用
4. **统计分析**: 所有指标准确展示，支持导出
5. **模板库**: 新媒体模板 >= 6个
6. **账号管理**: OAuth认证全流程可用
7. **知识库**: 搜索准确率 > 85%

### 性能验收

1. 工作流创建响应时间 < 5秒
2. 知识库搜索响应时间 < 2秒
3. 执行状态更新延迟 < 1秒（WebSocket）
4. 平台工具API调用超时 < 30秒

---

## 八、附录

### A. 关键文件位置清单

```
工具执行器:
├── src/lib/ai/function-calling/executors/
│   ├── index.ts                    # 工具注册
│   ├── http.ts                     # HTTP请求
│   ├── feishu-bitable.ts           # 飞书多维表格
│   ├── wechat-mp.ts                # 微信公众号
│   ├── douyin-video.ts             # 抖音
│   ├── wechat-channels.ts          # 视频号
│   └── xiaohongshu.ts              # 小红书

AI助手:
├── src/app/api/ai-assistant/
│   ├── create-workflow/route.ts    # 创建工作流
│   ├── diagnose/route.ts           # 诊断
│   ├── optimize/route.ts           # 优化
│   └── refine/route.ts             # 精修

多模态处理:
├── src/lib/workflow/processors/
│   ├── modality-router.ts          # 模态路由
│   ├── code.ts                     # 代码执行
│   └── output.ts                   # 输出处理

知识库:
├── src/lib/knowledge/
│   ├── search.ts                   # 搜索核心
│   ├── embedding.ts                # 向量嵌入
│   ├── bm25/index.ts               # BM25算法
│   └── vector-store/               # 向量存储

模板:
├── src/lib/templates/
│   └── official-templates.ts       # 官方模板
```

### B. 环境变量配置

```bash
# OAuth配置
OAUTH_XHS_CLIENT_ID=
OAUTH_XHS_CLIENT_SECRET=
OAUTH_DOUYIN_CLIENT_ID=
OAUTH_DOUYIN_CLIENT_SECRET=
OAUTH_WECHAT_CHANNELS_CLIENT_ID=
OAUTH_WECHAT_CHANNELS_CLIENT_SECRET=

# 向量存储
PGVECTOR_DATABASE_URL=
NEXT_PUBLIC_SUPABASE_URL=
SUPABASE_SERVICE_ROLE_KEY=

# 重排序
JINA_API_KEY=
```

---

**文档结束**

*本报告基于2026年1月1日代码库状态生成，后续开发应参考最新代码变更进行调整。*
