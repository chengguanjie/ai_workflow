# AI 配置错误修复说明

## 问题描述

用户在执行工作流时，包含 AI 功能的节点（如"文本处理节点"，可能显示为"替代"）报错：
- 错误信息：`节点"替代"执行失败：未配置 AI 服务商`
- 但配置面板显示已经选择了服务商配置

## 问题原因分析

经过代码分析，发现问题的根本原因可能是：

1. **AI 配置被禁用或删除**
   - 节点保存了 AI 配置的 ID (`aiConfigId`)
   - 但该配置可能后续被设置为非激活状态（`isActive: false`）
   - 或者该配置已被删除

2. **组织 ID 不匹配**
   - AI 配置关联了特定的组织 ID
   - 执行工作流时使用当前用户的组织 ID
   - 如果两者不匹配，将无法找到配置

3. **缺少默认配置**
   - 当节点没有指定配置 ID 时，系统会查找默认配置
   - 如果组织没有设置默认的 AI 服务商，也会报错

## 已实施的修复

### 1. 添加详细的错误日志
在 `src/lib/workflow/processors/process.ts` 中添加了详细的诊断日志：
- 当找不到配置时，记录配置的详细信息
- 包括配置是否存在、组织 ID 是否匹配、激活状态等

### 2. 改进错误提示
将模糊的错误信息改为更具体的提示：
- 指定配置不存在时：提示检查配置是否被删除或禁用
- 缺少默认配置时：提示去设置页面添加默认配置

## 解决方案

### 对于用户

1. **检查 AI 配置状态**
   - 前往"设置 → AI 配置"页面
   - 确认所使用的配置是否为"激活"状态
   - 如果被禁用，重新激活它

2. **重新选择配置**
   - 编辑工作流节点
   - 在"AI 配置"标签页重新选择一个激活的服务商配置
   - 保存节点配置

3. **设置默认配置**
   - 在"设置 → AI 配置"页面
   - 将一个配置设置为默认
   - 这样新节点会自动使用默认配置

### 后续优化建议

1. **配置面板优化**
   - 只显示激活状态的 AI 配置
   - 当选中的配置被禁用时，显示警告提示

2. **配置验证**
   - 在保存节点时验证配置是否有效
   - 防止保存无效的配置引用

3. **配置变更处理**
   - 当 AI 配置被禁用或删除时
   - 自动通知使用该配置的工作流
   - 或提供批量更新工具

## 技术细节

### 配置查找逻辑
```typescript
const where = configId
  ? { id: configId, organizationId: context.organizationId, isActive: true }
  : { organizationId: context.organizationId, isDefault: true, isActive: true }
```

系统要求配置同时满足：
- ID 匹配（如果指定了 configId）
- 组织 ID 匹配
- 激活状态为 true
- 默认配置（如果没有指定 configId）

### 执行上下文
工作流执行时的组织 ID 来自当前登录用户：
```typescript
executeWorkflow(workflowId, user.organizationId, user.id, input)
```

这确保了用户只能使用自己组织的 AI 配置。